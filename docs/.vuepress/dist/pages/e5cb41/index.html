<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB | Chiriri&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="后端技术博客,专注后端学习与总结。Java,Spring,Scala,Hadoop,Spark,Flink,Python,Linux,Docker等技术文章。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="后端博客,个人技术博客,后端/前端开发,后端/前端框架,web前端,后端面试题,技术文档,学习,面试,Java,Scala,Hadoop,Spring,Spring Boot,Spring Cloud,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.51266fe2.css" as="style"><link rel="preload" href="/assets/js/app.40dd8ecd.js" as="script"><link rel="preload" href="/assets/js/2.6a9cea3c.js" as="script"><link rel="preload" href="/assets/js/3.6634b688.js" as="script"><link rel="preload" href="/assets/js/184.15b6aa3d.js" as="script"><link rel="preload" href="/assets/js/5.69b21161.js" as="script"><link rel="prefetch" href="/assets/js/10.2c01b12e.js"><link rel="prefetch" href="/assets/js/100.b3f59007.js"><link rel="prefetch" href="/assets/js/101.b744e9c9.js"><link rel="prefetch" href="/assets/js/102.0e6c35dd.js"><link rel="prefetch" href="/assets/js/103.f22fef25.js"><link rel="prefetch" href="/assets/js/104.9be911d5.js"><link rel="prefetch" href="/assets/js/105.1469eafc.js"><link rel="prefetch" href="/assets/js/106.9d267c5a.js"><link rel="prefetch" href="/assets/js/107.b728fd5c.js"><link rel="prefetch" href="/assets/js/108.4c0db71c.js"><link rel="prefetch" href="/assets/js/109.cc8fb748.js"><link rel="prefetch" href="/assets/js/11.664036c6.js"><link rel="prefetch" href="/assets/js/110.c147c22c.js"><link rel="prefetch" href="/assets/js/111.2b04a883.js"><link rel="prefetch" href="/assets/js/112.db53739e.js"><link rel="prefetch" href="/assets/js/113.1d5b2eff.js"><link rel="prefetch" href="/assets/js/114.856088cb.js"><link rel="prefetch" href="/assets/js/115.1074b8af.js"><link rel="prefetch" href="/assets/js/116.d88d0a22.js"><link rel="prefetch" href="/assets/js/117.1b17ec7c.js"><link rel="prefetch" href="/assets/js/118.3f26f81e.js"><link rel="prefetch" href="/assets/js/119.b68c191a.js"><link rel="prefetch" href="/assets/js/12.f548447f.js"><link rel="prefetch" href="/assets/js/120.49495207.js"><link rel="prefetch" href="/assets/js/121.4a8174b0.js"><link rel="prefetch" href="/assets/js/122.3d985319.js"><link rel="prefetch" href="/assets/js/123.2db02e7a.js"><link rel="prefetch" href="/assets/js/124.b26fd0a8.js"><link rel="prefetch" href="/assets/js/125.1404e4be.js"><link rel="prefetch" href="/assets/js/126.74732852.js"><link rel="prefetch" href="/assets/js/127.6e95f432.js"><link rel="prefetch" href="/assets/js/128.8056cd04.js"><link rel="prefetch" href="/assets/js/129.05eb9883.js"><link rel="prefetch" href="/assets/js/13.8d4c6448.js"><link rel="prefetch" href="/assets/js/130.1e945430.js"><link rel="prefetch" href="/assets/js/131.17e8268c.js"><link rel="prefetch" href="/assets/js/132.5e12d60c.js"><link rel="prefetch" href="/assets/js/133.9d349ee6.js"><link rel="prefetch" href="/assets/js/134.836c4bd5.js"><link rel="prefetch" href="/assets/js/135.b0a6cae7.js"><link rel="prefetch" href="/assets/js/136.9c8151f9.js"><link rel="prefetch" href="/assets/js/137.5fe25c85.js"><link rel="prefetch" href="/assets/js/138.f7e7fbc9.js"><link rel="prefetch" href="/assets/js/139.d56b3843.js"><link rel="prefetch" href="/assets/js/14.b6ff5175.js"><link rel="prefetch" href="/assets/js/140.0585b72d.js"><link rel="prefetch" href="/assets/js/141.3dd0e26d.js"><link rel="prefetch" href="/assets/js/142.94865158.js"><link rel="prefetch" href="/assets/js/143.f5880cb7.js"><link rel="prefetch" href="/assets/js/144.51410816.js"><link rel="prefetch" href="/assets/js/145.f71d7f5a.js"><link rel="prefetch" href="/assets/js/146.cba6467b.js"><link rel="prefetch" href="/assets/js/147.340bfbe6.js"><link rel="prefetch" href="/assets/js/148.e7f5ad4c.js"><link rel="prefetch" href="/assets/js/149.c56c9d48.js"><link rel="prefetch" href="/assets/js/15.730457a3.js"><link rel="prefetch" href="/assets/js/150.efff543b.js"><link rel="prefetch" href="/assets/js/151.46d42773.js"><link rel="prefetch" href="/assets/js/152.b313c215.js"><link rel="prefetch" href="/assets/js/153.72694bb0.js"><link rel="prefetch" href="/assets/js/154.11fb04c2.js"><link rel="prefetch" href="/assets/js/155.3d138baa.js"><link rel="prefetch" href="/assets/js/156.3089831f.js"><link rel="prefetch" href="/assets/js/157.d0ff3b6c.js"><link rel="prefetch" href="/assets/js/158.94feb5c7.js"><link rel="prefetch" href="/assets/js/159.a3baa78c.js"><link rel="prefetch" href="/assets/js/16.f9e71cf5.js"><link rel="prefetch" href="/assets/js/160.86a99a62.js"><link rel="prefetch" href="/assets/js/161.45b8b66b.js"><link rel="prefetch" href="/assets/js/162.c64e56ec.js"><link rel="prefetch" href="/assets/js/163.483a832b.js"><link rel="prefetch" href="/assets/js/164.c19901cd.js"><link rel="prefetch" href="/assets/js/165.f48d973d.js"><link rel="prefetch" href="/assets/js/166.4aa2f408.js"><link rel="prefetch" href="/assets/js/167.5acd78d8.js"><link rel="prefetch" href="/assets/js/168.7e540d2c.js"><link rel="prefetch" href="/assets/js/169.1a43a9fa.js"><link rel="prefetch" href="/assets/js/17.208779aa.js"><link rel="prefetch" href="/assets/js/170.2042e4e4.js"><link rel="prefetch" href="/assets/js/171.0b170f15.js"><link rel="prefetch" href="/assets/js/172.3f7c4192.js"><link rel="prefetch" href="/assets/js/173.9f14fd16.js"><link rel="prefetch" href="/assets/js/174.19942088.js"><link rel="prefetch" href="/assets/js/175.5d5f9532.js"><link rel="prefetch" href="/assets/js/176.cfa74820.js"><link rel="prefetch" href="/assets/js/177.7057d212.js"><link rel="prefetch" href="/assets/js/178.8b82debd.js"><link rel="prefetch" href="/assets/js/179.b1df9ddf.js"><link rel="prefetch" href="/assets/js/18.ab9a3bbb.js"><link rel="prefetch" href="/assets/js/180.4085708e.js"><link rel="prefetch" href="/assets/js/181.55d0a9dd.js"><link rel="prefetch" href="/assets/js/182.dfbf6d8c.js"><link rel="prefetch" href="/assets/js/183.56ba6c6a.js"><link rel="prefetch" href="/assets/js/185.d70097e9.js"><link rel="prefetch" href="/assets/js/186.655e747b.js"><link rel="prefetch" href="/assets/js/187.761a3f9f.js"><link rel="prefetch" href="/assets/js/188.2db23a7d.js"><link rel="prefetch" href="/assets/js/189.6e4875f8.js"><link rel="prefetch" href="/assets/js/19.ad906bc0.js"><link rel="prefetch" href="/assets/js/190.cd67fc8e.js"><link rel="prefetch" href="/assets/js/191.f14772fb.js"><link rel="prefetch" href="/assets/js/192.4efaec96.js"><link rel="prefetch" href="/assets/js/193.80a5eeb7.js"><link rel="prefetch" href="/assets/js/194.fa5ded41.js"><link rel="prefetch" href="/assets/js/195.12256e2b.js"><link rel="prefetch" href="/assets/js/196.dc77f375.js"><link rel="prefetch" href="/assets/js/197.b004aa4b.js"><link rel="prefetch" href="/assets/js/198.acf92801.js"><link rel="prefetch" href="/assets/js/199.20b22e09.js"><link rel="prefetch" href="/assets/js/20.e27af5ca.js"><link rel="prefetch" href="/assets/js/200.826af643.js"><link rel="prefetch" href="/assets/js/201.e5fb447a.js"><link rel="prefetch" href="/assets/js/202.48d1b308.js"><link rel="prefetch" href="/assets/js/203.84d332e0.js"><link rel="prefetch" href="/assets/js/204.cc7d6f19.js"><link rel="prefetch" href="/assets/js/205.f7d9cd24.js"><link rel="prefetch" href="/assets/js/206.dc5c4afb.js"><link rel="prefetch" href="/assets/js/207.5f7972ef.js"><link rel="prefetch" href="/assets/js/208.70becdf7.js"><link rel="prefetch" href="/assets/js/209.cad1c569.js"><link rel="prefetch" href="/assets/js/21.799ac5c3.js"><link rel="prefetch" href="/assets/js/210.fa527b0e.js"><link rel="prefetch" href="/assets/js/211.993b8c0e.js"><link rel="prefetch" href="/assets/js/212.d93d494e.js"><link rel="prefetch" href="/assets/js/213.4b16adac.js"><link rel="prefetch" href="/assets/js/214.6ec78061.js"><link rel="prefetch" href="/assets/js/215.13029f81.js"><link rel="prefetch" href="/assets/js/216.689d0457.js"><link rel="prefetch" href="/assets/js/217.34c99396.js"><link rel="prefetch" href="/assets/js/218.15ab7732.js"><link rel="prefetch" href="/assets/js/219.75f13837.js"><link rel="prefetch" href="/assets/js/22.65a08aeb.js"><link rel="prefetch" href="/assets/js/220.c56ac0a9.js"><link rel="prefetch" href="/assets/js/221.895f3699.js"><link rel="prefetch" href="/assets/js/222.27eeeb52.js"><link rel="prefetch" href="/assets/js/223.12668c30.js"><link rel="prefetch" href="/assets/js/224.05ac3ee3.js"><link rel="prefetch" href="/assets/js/225.edd622c1.js"><link rel="prefetch" href="/assets/js/226.1c461bc8.js"><link rel="prefetch" href="/assets/js/227.ecd8c7d2.js"><link rel="prefetch" href="/assets/js/228.27d830bc.js"><link rel="prefetch" href="/assets/js/229.e81fb37c.js"><link rel="prefetch" href="/assets/js/23.8536e70e.js"><link rel="prefetch" href="/assets/js/230.d0ba3c56.js"><link rel="prefetch" href="/assets/js/231.14b36b1c.js"><link rel="prefetch" href="/assets/js/232.72276e73.js"><link rel="prefetch" href="/assets/js/233.e69b011e.js"><link rel="prefetch" href="/assets/js/234.09a1a458.js"><link rel="prefetch" href="/assets/js/235.608e7252.js"><link rel="prefetch" href="/assets/js/236.ff627f0b.js"><link rel="prefetch" href="/assets/js/237.07b8be2c.js"><link rel="prefetch" href="/assets/js/238.dae66b3b.js"><link rel="prefetch" href="/assets/js/239.06c9ecd8.js"><link rel="prefetch" href="/assets/js/24.3d058006.js"><link rel="prefetch" href="/assets/js/240.fee390d1.js"><link rel="prefetch" href="/assets/js/241.d42db9a1.js"><link rel="prefetch" href="/assets/js/242.09b84c17.js"><link rel="prefetch" href="/assets/js/243.2c2bc879.js"><link rel="prefetch" href="/assets/js/244.9dc51c1c.js"><link rel="prefetch" href="/assets/js/245.000b0100.js"><link rel="prefetch" href="/assets/js/246.0ac8526d.js"><link rel="prefetch" href="/assets/js/247.93bccdfd.js"><link rel="prefetch" href="/assets/js/248.1320538e.js"><link rel="prefetch" href="/assets/js/249.8830e715.js"><link rel="prefetch" href="/assets/js/25.f1c45c8c.js"><link rel="prefetch" href="/assets/js/250.9ffdfca4.js"><link rel="prefetch" href="/assets/js/251.1daed062.js"><link rel="prefetch" href="/assets/js/252.f3000209.js"><link rel="prefetch" href="/assets/js/253.aea926e5.js"><link rel="prefetch" href="/assets/js/254.6d0eb14e.js"><link rel="prefetch" href="/assets/js/255.8db9d533.js"><link rel="prefetch" href="/assets/js/256.a11d12cb.js"><link rel="prefetch" href="/assets/js/257.62603a31.js"><link rel="prefetch" href="/assets/js/258.dcedf3c8.js"><link rel="prefetch" href="/assets/js/259.0518d1c7.js"><link rel="prefetch" href="/assets/js/26.f2173fd0.js"><link rel="prefetch" href="/assets/js/260.842f6899.js"><link rel="prefetch" href="/assets/js/261.1460bcaa.js"><link rel="prefetch" href="/assets/js/262.acac0383.js"><link rel="prefetch" href="/assets/js/263.6ea1fc01.js"><link rel="prefetch" href="/assets/js/264.d02d65d5.js"><link rel="prefetch" href="/assets/js/265.1ede84db.js"><link rel="prefetch" href="/assets/js/266.662695a2.js"><link rel="prefetch" href="/assets/js/267.f0620bc3.js"><link rel="prefetch" href="/assets/js/268.2da06d21.js"><link rel="prefetch" href="/assets/js/269.d63285e1.js"><link rel="prefetch" href="/assets/js/27.9ccd43d1.js"><link rel="prefetch" href="/assets/js/270.bc08bf36.js"><link rel="prefetch" href="/assets/js/271.272e051b.js"><link rel="prefetch" href="/assets/js/272.54adbe1d.js"><link rel="prefetch" href="/assets/js/273.99b5dd67.js"><link rel="prefetch" href="/assets/js/274.d9a1ff1b.js"><link rel="prefetch" href="/assets/js/275.6fa57e84.js"><link rel="prefetch" href="/assets/js/276.f8e1117c.js"><link rel="prefetch" href="/assets/js/277.f86f7050.js"><link rel="prefetch" href="/assets/js/278.18ef4ec9.js"><link rel="prefetch" href="/assets/js/279.c10e792b.js"><link rel="prefetch" href="/assets/js/28.da91b7e2.js"><link rel="prefetch" href="/assets/js/280.480236b8.js"><link rel="prefetch" href="/assets/js/281.cff870df.js"><link rel="prefetch" href="/assets/js/282.677b72f8.js"><link rel="prefetch" href="/assets/js/283.8362f4fe.js"><link rel="prefetch" href="/assets/js/284.7d8c3007.js"><link rel="prefetch" href="/assets/js/285.003d79ff.js"><link rel="prefetch" href="/assets/js/286.4beb6df8.js"><link rel="prefetch" href="/assets/js/287.f4435cc2.js"><link rel="prefetch" href="/assets/js/288.2aeed3e9.js"><link rel="prefetch" href="/assets/js/289.c8be086b.js"><link rel="prefetch" href="/assets/js/29.461bce84.js"><link rel="prefetch" href="/assets/js/290.ab89b490.js"><link rel="prefetch" href="/assets/js/291.9fd0deda.js"><link rel="prefetch" href="/assets/js/292.142d04cd.js"><link rel="prefetch" href="/assets/js/293.d3e0e817.js"><link rel="prefetch" href="/assets/js/294.6580c1eb.js"><link rel="prefetch" href="/assets/js/295.799d2b7d.js"><link rel="prefetch" href="/assets/js/296.e2279804.js"><link rel="prefetch" href="/assets/js/297.df6bc992.js"><link rel="prefetch" href="/assets/js/298.2c39fdeb.js"><link rel="prefetch" href="/assets/js/299.8d63e833.js"><link rel="prefetch" href="/assets/js/30.8fdd5612.js"><link rel="prefetch" href="/assets/js/300.65620f4b.js"><link rel="prefetch" href="/assets/js/301.3284de8c.js"><link rel="prefetch" href="/assets/js/302.e3ff1017.js"><link rel="prefetch" href="/assets/js/303.bbc7c3b2.js"><link rel="prefetch" href="/assets/js/304.dd7907f9.js"><link rel="prefetch" href="/assets/js/305.f18fb17b.js"><link rel="prefetch" href="/assets/js/306.e82e1d30.js"><link rel="prefetch" href="/assets/js/307.dd96a4d6.js"><link rel="prefetch" href="/assets/js/308.058f6d88.js"><link rel="prefetch" href="/assets/js/31.f6fe2381.js"><link rel="prefetch" href="/assets/js/32.f5aed9a2.js"><link rel="prefetch" href="/assets/js/33.5932f9b2.js"><link rel="prefetch" href="/assets/js/34.589697c2.js"><link rel="prefetch" href="/assets/js/35.f13cad1b.js"><link rel="prefetch" href="/assets/js/36.a27e3982.js"><link rel="prefetch" href="/assets/js/37.1eb4eed4.js"><link rel="prefetch" href="/assets/js/38.060b5e7e.js"><link rel="prefetch" href="/assets/js/39.dc67fc14.js"><link rel="prefetch" href="/assets/js/4.8c3c0acd.js"><link rel="prefetch" href="/assets/js/40.498ba062.js"><link rel="prefetch" href="/assets/js/41.ea0dc104.js"><link rel="prefetch" href="/assets/js/42.fbe5561c.js"><link rel="prefetch" href="/assets/js/43.db0e44fd.js"><link rel="prefetch" href="/assets/js/44.84603aa3.js"><link rel="prefetch" href="/assets/js/45.6906fb0e.js"><link rel="prefetch" href="/assets/js/46.c16b17b4.js"><link rel="prefetch" href="/assets/js/47.c709a621.js"><link rel="prefetch" href="/assets/js/48.bfdd7f0d.js"><link rel="prefetch" href="/assets/js/49.504ac581.js"><link rel="prefetch" href="/assets/js/50.eae7b421.js"><link rel="prefetch" href="/assets/js/51.6f8c192b.js"><link rel="prefetch" href="/assets/js/52.fcad9f75.js"><link rel="prefetch" href="/assets/js/53.59c1cdf1.js"><link rel="prefetch" href="/assets/js/54.c6056518.js"><link rel="prefetch" href="/assets/js/55.62b17cc8.js"><link rel="prefetch" href="/assets/js/56.28d2d58f.js"><link rel="prefetch" href="/assets/js/57.e18df71f.js"><link rel="prefetch" href="/assets/js/58.7b004771.js"><link rel="prefetch" href="/assets/js/59.4271ceaa.js"><link rel="prefetch" href="/assets/js/6.6b6896fe.js"><link rel="prefetch" href="/assets/js/60.a513cb60.js"><link rel="prefetch" href="/assets/js/61.3d8ba833.js"><link rel="prefetch" href="/assets/js/62.aafdece6.js"><link rel="prefetch" href="/assets/js/63.6d65dc9c.js"><link rel="prefetch" href="/assets/js/64.b6732f71.js"><link rel="prefetch" href="/assets/js/65.ea7a6b22.js"><link rel="prefetch" href="/assets/js/66.d2cffa21.js"><link rel="prefetch" href="/assets/js/67.641cd913.js"><link rel="prefetch" href="/assets/js/68.19b6fe07.js"><link rel="prefetch" href="/assets/js/69.10facc31.js"><link rel="prefetch" href="/assets/js/7.726dbc5f.js"><link rel="prefetch" href="/assets/js/70.14645f41.js"><link rel="prefetch" href="/assets/js/71.a0b3696a.js"><link rel="prefetch" href="/assets/js/72.e5be5fe1.js"><link rel="prefetch" href="/assets/js/73.3f99599e.js"><link rel="prefetch" href="/assets/js/74.28993790.js"><link rel="prefetch" href="/assets/js/75.1f27d919.js"><link rel="prefetch" href="/assets/js/76.5cf38880.js"><link rel="prefetch" href="/assets/js/77.dafc6a5e.js"><link rel="prefetch" href="/assets/js/78.8e47a6fe.js"><link rel="prefetch" href="/assets/js/79.1f75688f.js"><link rel="prefetch" href="/assets/js/8.99cd54ee.js"><link rel="prefetch" href="/assets/js/80.325f1cde.js"><link rel="prefetch" href="/assets/js/81.8cca5128.js"><link rel="prefetch" href="/assets/js/82.8395fcab.js"><link rel="prefetch" href="/assets/js/83.43951c63.js"><link rel="prefetch" href="/assets/js/84.ad728d6d.js"><link rel="prefetch" href="/assets/js/85.ebcc76cb.js"><link rel="prefetch" href="/assets/js/86.d697fdcb.js"><link rel="prefetch" href="/assets/js/87.39017ed5.js"><link rel="prefetch" href="/assets/js/88.0bf64781.js"><link rel="prefetch" href="/assets/js/89.e73af49c.js"><link rel="prefetch" href="/assets/js/9.c89f984c.js"><link rel="prefetch" href="/assets/js/90.fbb12a35.js"><link rel="prefetch" href="/assets/js/91.4839b991.js"><link rel="prefetch" href="/assets/js/92.e7ade2e9.js"><link rel="prefetch" href="/assets/js/93.3faaeac7.js"><link rel="prefetch" href="/assets/js/94.25fb6f2d.js"><link rel="prefetch" href="/assets/js/95.9a84e931.js"><link rel="prefetch" href="/assets/js/96.e68e0aae.js"><link rel="prefetch" href="/assets/js/97.d24a88cc.js"><link rel="prefetch" href="/assets/js/98.7175d22e.js"><link rel="prefetch" href="/assets/js/99.76456f24.js">
    <link rel="stylesheet" href="/assets/css/0.styles.51266fe2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Chiriri's blog" class="logo"> <span class="site-name can-hide">Chiriri's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/Java/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/df8281/" class="nav-link">JavaSE</a></li><li class="dropdown-subitem"><a href="/pages/544a3f/" class="nav-link">JavaEE</a></li></ul></li><li class="dropdown-item"><h4>Python</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/35c9ab/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/pages/cf7131/" class="nav-link">Python模块</a></li><li class="dropdown-subitem"><a href="/pages/ddf9fb/" class="nav-link">机器学习</a></li></ul></li><li class="dropdown-item"><h4>服务器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/124a07/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/pages/e051f6/" class="nav-link">SQL</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/hadoop/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e0c98/" class="nav-link">Hadoop</a></li><li class="dropdown-item"><!----> <a href="/pages/f38fc8/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/2315d6/" class="nav-link">Hive</a></li><li class="dropdown-item"><!----> <a href="/pages/b084db/" class="nav-link">Flume</a></li><li class="dropdown-item"><!----> <a href="/pages/872cdc/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/bac882/" class="nav-link">Azkaban</a></li><li class="dropdown-item"><!----> <a href="/pages/310c39/" class="nav-link">Hbase</a></li><li class="dropdown-item"><!----> <a href="/pages/d2afbe/" class="nav-link">Scala</a></li><li class="dropdown-item"><!----> <a href="/pages/cc783e/" class="nav-link">Spark</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/23186a/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/pages/6af871/" class="nav-link">Vue2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="408" class="dropdown-title"><a href="/408/" class="link-title">408</a> <span class="title" style="display:none;">408</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e5251/" class="nav-link">数据结构与算法</a></li></ul></div></div> <a href="https://github.com/Iekrwh/blog-VuePress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/$7ZY44WI036RW5{EPWQXCX6.jpg"> <div class="blogger-info"><h3>Iekr</h3> <span>苦逼后端开发</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/Java/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/df8281/" class="nav-link">JavaSE</a></li><li class="dropdown-subitem"><a href="/pages/544a3f/" class="nav-link">JavaEE</a></li></ul></li><li class="dropdown-item"><h4>Python</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/35c9ab/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/pages/cf7131/" class="nav-link">Python模块</a></li><li class="dropdown-subitem"><a href="/pages/ddf9fb/" class="nav-link">机器学习</a></li></ul></li><li class="dropdown-item"><h4>服务器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/124a07/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/pages/e051f6/" class="nav-link">SQL</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/hadoop/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e0c98/" class="nav-link">Hadoop</a></li><li class="dropdown-item"><!----> <a href="/pages/f38fc8/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/2315d6/" class="nav-link">Hive</a></li><li class="dropdown-item"><!----> <a href="/pages/b084db/" class="nav-link">Flume</a></li><li class="dropdown-item"><!----> <a href="/pages/872cdc/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/bac882/" class="nav-link">Azkaban</a></li><li class="dropdown-item"><!----> <a href="/pages/310c39/" class="nav-link">Hbase</a></li><li class="dropdown-item"><!----> <a href="/pages/d2afbe/" class="nav-link">Scala</a></li><li class="dropdown-item"><!----> <a href="/pages/cc783e/" class="nav-link">Spark</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/23186a/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/pages/6af871/" class="nav-link">Vue2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="408" class="dropdown-title"><a href="/408/" class="link-title">408</a> <span class="title" style="display:none;">408</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e5251/" class="nav-link">数据结构与算法</a></li></ul></div></div> <a href="https://github.com/Iekrwh/blog-VuePress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaSE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaEE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SQL</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e051f6/" class="sidebar-link">常见的数据库产品</a></li><li><a href="/pages/4b2b60/" class="sidebar-link">数据库相关概念</a></li><li><a href="/pages/d2b3d3/" class="sidebar-link">数据库存储数据的特点</a></li><li><a href="/pages/641ffa/" class="sidebar-link">MySQL服务端</a></li><li><a href="/pages/a4dffe/" class="sidebar-link">环境变量</a></li><li><a href="/pages/8c64bc/" class="sidebar-link">命令符指令</a></li><li><a href="/pages/4c9417/" class="sidebar-link">SQL语句</a></li><li><a href="/pages/04fedb/" class="sidebar-link">数据库</a></li><li><a href="/pages/5a2265/" class="sidebar-link">表</a></li><li><a href="/pages/de8702/" class="sidebar-link">约束</a></li><li><a href="/pages/89e8d8/" class="sidebar-link">多表操作</a></li><li><a href="/pages/3293cf/" class="sidebar-link">视图</a></li><li><a href="/pages/f561ab/" class="sidebar-link">备份</a></li><li><a href="/pages/336822/" class="sidebar-link">MySQL 存储过程和函数</a></li><li><a href="/pages/108b35/" class="sidebar-link">触发器</a></li><li><a href="/pages/4c8706/" class="sidebar-link">事务</a></li><li><a href="/pages/7d59ad/" class="sidebar-link">存储引擎</a></li><li><a href="/pages/acc2dd/" class="sidebar-link">索引</a></li><li><a href="/pages/3c034d/" class="sidebar-link">锁</a></li><li><a href="/pages/3ca264/" class="sidebar-link">MyCat 中间件</a></li><li><a href="/pages/4a12e8/" class="sidebar-link">Nosql</a></li><li><a href="/pages/a002c8/" class="sidebar-link">Redis</a></li><li><a href="/pages/4e4f7f/" class="sidebar-link">Redis高级</a></li><li><a href="/pages/e5cb41/" aria-current="page" class="active sidebar-link">MongoDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#体系结构" class="sidebar-link">体系结构</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#数据模型" class="sidebar-link">数据模型</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#单机部署" class="sidebar-link">单机部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#windows启动" class="sidebar-link">windows启动</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#linux启动" class="sidebar-link">Linux启动</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#数据库" class="sidebar-link">数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#选择和创建数据库" class="sidebar-link">选择和创建数据库</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#查询当前有权限查看的数据" class="sidebar-link">查询当前有权限查看的数据</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#查看当前正在使用的数据库名称" class="sidebar-link">查看当前正在使用的数据库名称</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#数据库命名规范" class="sidebar-link">数据库命名规范</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#默认三个数据库作用" class="sidebar-link">默认三个数据库作用</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#数据库删除" class="sidebar-link">数据库删除</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#集合" class="sidebar-link">集合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#显式创建" class="sidebar-link">显式创建</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#隐式创建" class="sidebar-link">隐式创建</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#查询集合" class="sidebar-link">查询集合</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#集合删除" class="sidebar-link">集合删除</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#文档crud" class="sidebar-link">文档CRUD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#插入" class="sidebar-link">插入</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#查询" class="sidebar-link">查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#更新" class="sidebar-link">更新</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#删除" class="sidebar-link">删除</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#文档的分页查询" class="sidebar-link">文档的分页查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#统计查询" class="sidebar-link">统计查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#分页列表查询" class="sidebar-link">分页列表查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#排序查询" class="sidebar-link">排序查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#分页和排序查询的顺序" class="sidebar-link">分页和排序查询的顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#高级查询" class="sidebar-link">高级查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#正则条件查询" class="sidebar-link">正则条件查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#比较查询" class="sidebar-link">比较查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#包含查询" class="sidebar-link">包含查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#不包含查询" class="sidebar-link">不包含查询</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#条件连接查询" class="sidebar-link">条件连接查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#索引" class="sidebar-link">索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#单字段索引" class="sidebar-link">单字段索引</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#复合索引" class="sidebar-link">复合索引</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#其他索引" class="sidebar-link">其他索引</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#索引管理" class="sidebar-link">索引管理</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#索引的使用" class="sidebar-link">索引的使用</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#涵盖查询" class="sidebar-link">涵盖查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#java连接mongodb" class="sidebar-link">Java连接MongoDB</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#评论案例" class="sidebar-link">评论案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#模块搭建" class="sidebar-link">模块搭建</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#实体类" class="sidebar-link">实体类</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#增删改查方法" class="sidebar-link">增删改查方法</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#创建测试方法" class="sidebar-link">创建测试方法</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#分页查询测试" class="sidebar-link">分页查询测试</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#评论点赞" class="sidebar-link">评论点赞</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#副本集" class="sidebar-link">副本集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#副本集创建" class="sidebar-link">副本集创建</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#初始化配置副本集和主节点" class="sidebar-link">初始化配置副本集和主节点</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#添加副本从节点" class="sidebar-link">添加副本从节点</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#添加仲裁节点" class="sidebar-link">添加仲裁节点</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#副本集的数据读写操作" class="sidebar-link">副本集的数据读写操作</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#主节点的选举原则" class="sidebar-link">主节点的选举原则</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#提升优先级" class="sidebar-link">提升优先级</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#compass连接副本集" class="sidebar-link">Compass连接副本集</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#springdatamongodb连接副本集" class="sidebar-link">SpringDataMongoDB连接副本集</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#分片集群" class="sidebar-link">分片集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#搭建分片集群架构" class="sidebar-link">搭建分片集群架构</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#compass连接分片集群" class="sidebar-link">Compass连接分片集群</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#springdatamongdb-连接分片集群" class="sidebar-link">SpringDataMongDB 连接分片集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#安全认证" class="sidebar-link">安全认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#角色" class="sidebar-link">角色</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#单实例安全认证" class="sidebar-link">单实例安全认证</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#副本集环境" class="sidebar-link">副本集环境</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#分片集群环境" class="sidebar-link">分片集群环境</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#_4-0新特性" class="sidebar-link">4.0新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/e5cb41/#加载外部js文件" class="sidebar-link">加载外部js文件</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#事务性" class="sidebar-link">事务性</a></li><li class="sidebar-sub-header"><a href="/pages/e5cb41/#聚合数据类型转换" class="sidebar-link">聚合数据类型转换</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>机器学习</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-5f68696a><div class="articleInfo" data-v-5f68696a><ul class="breadcrumbs" data-v-5f68696a><li data-v-5f68696a><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-5f68696a></a></li> <li data-v-5f68696a><a href="/categories/?category=%E5%90%8E%E7%AB%AF" title="分类" data-v-5f68696a>后端</a></li><li data-v-5f68696a><a href="/categories/?category=SQL" title="分类" data-v-5f68696a>SQL</a></li></ul> <div class="info" data-v-5f68696a><div title="作者" class="author iconfont icon-touxiang" data-v-5f68696a><a href="https://github.com/Iekrwh" target="_blank" title="作者" class="beLink" data-v-5f68696a>Iekr</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-5f68696a><a href="javascript:;" data-v-5f68696a>2022-03-18</a></div> <!----> <div class="page-view" style="margin-left:0;" data-v-f15bf7c8 data-v-5f68696a><div title="文章字数" class="book-words iconfont icon-book" data-v-f15bf7c8><a href="javascript:;" style="margin-left: 3px; color: #888" data-v-f15bf7c8>0</a></div> <!----> <div title="浏览量" class="page-view iconfont icon-view" data-v-f15bf7c8><a href="javascript:;" id="busuanzi_value_page_pv" class="view-data" style="color: #888; margin-left: 3px" data-v-f15bf7c8><i title="正在获取..." class="loading iconfont icon-loading" data-v-f15bf7c8></i></a></div></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">MongoDB<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h1> <p>MongoDB它支持的数据结构非常松散,是一种类JSON的格式 BSON 它即可以存储比较复杂的数据类型 又相当的灵活</p> <p>MongoDB中的记录是一个文档 它是一个键值对数据结构 MongoDB文档类似于JSON对象 即一个文档认为就是一个对象</p> <h2 id="体系结构"><a href="#体系结构" class="header-anchor">#</a> 体系结构</h2> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211013181311490.png" alt="image-20211013181311490"></p> <h2 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h2> <p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211013181407612.png" alt="image-20211013181407612"></p> <h2 id="单机部署"><a href="#单机部署" class="header-anchor">#</a> 单机部署</h2> <p>https://www.mongodb.com/try/download/community</p> <p>MongoDB的版本命名规范如：x.y.z；
y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；
y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；
z是修正版本号，数字越大越好。</p> <h3 id="windows启动"><a href="#windows启动" class="header-anchor">#</a> windows启动</h3> <ol><li><p>解压到本地</p></li> <li><p>在MongoDB目录下创建 data</p></li> <li><p>在data文件夹下 分别创建 db 和 logs 文件夹</p></li> <li><p>进入bin目录下命令行启动</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongod --dbpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>db --logpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>logs<span class="token punctuation">\</span>mongolog.log --logappend
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>MongoDB默认端口为27017 如果要指定端口可以通过--port来设置</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongod --dbpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>db --logpath<span class="token operator">=</span>D:<span class="token punctuation">\</span>compile<span class="token punctuation">\</span>mongodb-win32-x86_64-2012plus-4.2.16<span class="token punctuation">\</span>data<span class="token punctuation">\</span>logs<span class="token punctuation">\</span>mongolog.log --logappend --port <span class="token number">27018</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="使用配置文件启动"><a href="#使用配置文件启动" class="header-anchor">#</a> 使用配置文件启动</h4> <ol><li><p>在MongoDB目录下conf目录</p></li> <li><p>进入conf目录创建mongod.conf</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\compile\mongodb<span class="token punctuation">-</span>win32<span class="token punctuation">-</span>x86_64<span class="token punctuation">-</span>2012plus<span class="token punctuation">-</span>4.2.16\data\db
<span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token key atrule">path</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\compile\mongodb<span class="token punctuation">-</span>win32<span class="token punctuation">-</span>x86_64<span class="token punctuation">-</span>2012plus<span class="token punctuation">-</span>4.2.16\data\logs\mongolog.log
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>在bin目录下命令行启动</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongod -f <span class="token punctuation">..</span>/config/mongod.conf
<span class="token comment">#或者</span>
mongod --config <span class="token punctuation">..</span>/config/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <h4 id="连接数据库"><a href="#连接数据库" class="header-anchor">#</a> 连接数据库</h4> <ol><li><p>在bin目录下命令行启动</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongo
<span class="token comment">#或者</span>
mongo --host<span class="token operator">=</span><span class="token number">127.0</span>.0.1 --port<span class="token operator">=</span><span class="token number">27017</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>show dbs<span class="token punctuation">;</span> <span class="token comment">#查询数据库</span>
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token comment">#退出</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <h4 id="安装为服务项"><a href="#安装为服务项" class="header-anchor">#</a> 安装为服务项</h4> <p>在bin目录下执行</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongod --dbpath <span class="token string">&quot;D:<span class="token entity" title="\c">\c</span>ompile\mongodb-win32-x86_64-2012plus-4.2.16\data\db&quot;</span> --logpath <span class="token string">&quot;D:<span class="token entity" title="\c">\c</span>ompile\mongodb-win32-x86_64-2012plus-4.2.16\data\logs\mongolog.log&quot;</span> --serviceName <span class="token string">&quot;mongodb&quot;</span> --serviceDisplayName <span class="token string">&quot;mongodb&quot;</span> --install
net start mongodb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="linux启动"><a href="#linux启动" class="header-anchor">#</a> Linux启动</h3> <p>解压安装</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">wget</span> https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.15.tgz
<span class="token function">tar</span> -zxvf mongodb-linux-x86_64-rhel70-4.2.15.tgz
<span class="token function">mv</span> mongodb-linux-x86_64-rhel70-4.2.15 /usr/local/mongodb 
<span class="token function">mkdir</span> -p /mongodb/single/data/db  <span class="token comment">#数据目录</span>
<span class="token function">mkdir</span> -p /mongodb/single/log  <span class="token comment">#日志文件</span>
<span class="token function">vim</span> /mongodb/single/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 配置内容</span>
<span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment"># MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token comment"># The path of the log file to which mongod or mongos should send all diagnostic logging information</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment"># mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/single/log/mongod.log&quot;</span>
 <span class="token comment"># 当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment"># mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token comment"># The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;.</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/single/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
  <span class="token comment"># 启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment"># 启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment"># 服务实例绑定的IP，默认是localhost</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212    <span class="token comment">#ip为当前服务器局域网ip地址 不设置外部无法通过ip访问</span>
 <span class="token comment"># bindIp</span>
 <span class="token comment"># 绑定的端口，默认是27017</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>启动</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf
<span class="token comment">#/usr/local/mongodb/bin/mongod --config /mongodb/single/mongod.conf</span>
<span class="token comment">#查看防火墙状态</span>
systemctl status firewalld
<span class="token comment">#临时关闭防火墙</span>
systemctl stop firewalld
<span class="token comment">#开机禁止启动防火墙</span>
systemctl disable firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果一旦数据损坏 导致表死锁</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">rm</span> -f /mongodb/single/data/db/*.lock <span class="token comment">#删除锁文件</span>
/usr/local/mongdb/bin/mongod --repair
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="配置环境变量"><a href="#配置环境变量" class="header-anchor">#</a> 配置环境变量</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vi</span> /etc/profile
<span class="token comment">#配置内容</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MONGODB_HOME</span><span class="token operator">=</span>/usr/local/mongodb
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$MONGODB_HOME</span>/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="配置为服务加入启动"><a href="#配置为服务加入启动" class="header-anchor">#</a> 配置为服务加入启动</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /lib/systemd/system  
<span class="token function">vi</span> mongodb.service  
<span class="token comment">#配置内容</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>mongodb
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target remote-fs.target nss-lookup.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/mongodb/bin/mongod --config /mongodb/single/mongodb.conf
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/mongodb/bin/mongod --shutdown --config /mongodb/single/mongodb.conf
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#echo &quot;/usr/local/mongodb/bin/mongod --dbpath=/data/db --fork --bind_ip=0.0.0.0 --port 27017 --logpath=/data/db/log --logappend --auth&quot; &gt;&gt; /etc/rc.local</span>

<span class="token function">chmod</span> <span class="token number">754</span> mongodb.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#启动服务</span>
systemctl start mongodb.service
<span class="token comment">#关闭服务</span>
systemctl stop mongodb.service
<span class="token comment">#开机启动</span>
systemctl <span class="token builtin class-name">enable</span> mongodb.service
<span class="token comment">#关闭开启启动</span>
systemctl disable mongodb.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="标准的关闭方法"><a href="#标准的关闭方法" class="header-anchor">#</a> 标准的关闭方法</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongo
use admin
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>进程id关闭法</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> mongo
<span class="token function">kill</span> -2 pid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h2> <h3 id="选择和创建数据库"><a href="#选择和创建数据库" class="header-anchor">#</a> 选择和创建数据库</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#use 数据库名称   </span>
use articledb  <span class="token comment">#如果没有此数据库则自动创建 </span>
<span class="token comment">#如果新的数据库没有插入数据 showdbs是无法查看到新创建的数据库 因为此时数据库存储在内存当中 并未持久化</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="查询当前有权限查看的数据"><a href="#查询当前有权限查看的数据" class="header-anchor">#</a> 查询当前有权限查看的数据</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>show dbs
<span class="token comment">#或者</span>
show databases
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="查看当前正在使用的数据库名称"><a href="#查看当前正在使用的数据库名称" class="header-anchor">#</a> 查看当前正在使用的数据库名称</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="数据库命名规范"><a href="#数据库命名规范" class="header-anchor">#</a> 数据库命名规范</h3> <p>数据库名可以是满足以下条件的任意UTF-8字符串。</p> <ul><li>不能是空字符串（ &quot;&quot;)。</li> <li>不得含有 ' '（空格)、.、$、/、\和\0 (空字符)。</li> <li>应全部<strong>小写</strong>。</li> <li>最多 64字节。</li></ul> <p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p> <h3 id="默认三个数据库作用"><a href="#默认三个数据库作用" class="header-anchor">#</a> 默认三个数据库作用</h3> <ul><li><strong>admin</strong> ： 从权限的角度来看，这是&quot;root&quot;数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li> <li><strong>local</strong>: 这个数据<strong>永远不会被复制</strong>，可以用来存储限于本地单台服务器的任意集合</li> <li><strong>config</strong> : 当Mongo用于分片设置时，config数据库在内部使用，用于<strong>保存分片的相关信息</strong>。</li></ul> <h3 id="数据库删除"><a href="#数据库删除" class="header-anchor">#</a> 数据库删除</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.dropDatabase<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#删除当前使用的库</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="集合"><a href="#集合" class="header-anchor">#</a> 集合</h2> <p>集合,类似于关系型数据中的表</p> <h3 id="显式创建"><a href="#显式创建" class="header-anchor">#</a> 显式创建</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.createCollection(集合名)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;my&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#成功返回1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="隐式创建"><a href="#隐式创建" class="header-anchor">#</a> 隐式创建</h3> <p>当向一个集合中插入文档时 如果集合不存在 则自动创建集合</p> <p>通常我们使用隐式创建文档即可</p> <h3 id="查询集合"><a href="#查询集合" class="header-anchor">#</a> 查询集合</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>show collections <span class="token comment">#查询当前库的所有集合</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="集合删除"><a href="#集合删除" class="header-anchor">#</a> 集合删除</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.集合名.drop()</span>
db.my.drop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#成功则返回true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="文档crud"><a href="#文档crud" class="header-anchor">#</a> 文档CRUD</h2> <p>文档的数据结构和JSON基本一样</p> <p>索引存储在集合中数据都是 BSON 格式</p> <h3 id="插入"><a href="#插入" class="header-anchor">#</a> 插入</h3> <p>通过insert() 或者 save()  方法向集合中插入文档</p> <h4 id="单问插入"><a href="#单问插入" class="header-anchor">#</a> 单问插入</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#单文档插入</span>
db.collection.insert<span class="token punctuation">(</span>
 <span class="token operator">&lt;</span>document or array of documents<span class="token operator">&gt;</span>,
 <span class="token punctuation">{</span>
  writeConcern: <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span>,
  ordered: <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014200121256.png" alt="image-20211014200121256"></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.集合名.inset({&quot;&quot;})</span>
<span class="token comment">#单文档插入</span>
db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100000&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;今天天气真好，阳光明媚&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1001&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Rose&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span>:null<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#返回1则插入成功</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="批量插入"><a href="#批量插入" class="header-anchor">#</a> 批量插入</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#批量插入</span>
db.collection.insertMany<span class="token punctuation">(</span>
 <span class="token punctuation">[</span> <span class="token operator">&lt;</span>document <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> , <span class="token operator">&lt;</span>document <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>, <span class="token punctuation">..</span>. <span class="token punctuation">]</span>,
 <span class="token punctuation">{</span>
   writeConcern: <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span>,
   ordered: <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">#db.集合名.insertMany([{&quot;&quot;},{&quot;&quot;}])</span>
db.comment.insertMany<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1002&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;相忘于江湖&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-05T22:08:15.522Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1005&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;伊人憔悴&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-05T23:58:51.485Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;3&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;我一直喝凉开水，冬天夏天都喝。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1004&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;杰克船长&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T01:05:06.321Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;4&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;专家说不能空腹吃饭，影响健康。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;凯撒&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T08:18:35.288Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5&quot;</span>,<span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;100001&quot;</span>,<span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;</span>,<span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;凯撒&quot;</span>,<span class="token string">&quot;createdatetime&quot;</span>:new Date<span class="token punctuation">(</span><span class="token string">&quot;2019-08-06T11:01:02.521Z&quot;</span><span class="token punctuation">)</span>,<span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="try-catch"><a href="#try-catch" class="header-anchor">#</a> try catch</h4> <p>我们通过批量插入时由于数据较多可能会出现失败 我们可以通过try catch进行异常处理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  db<span class="token punctuation">.</span>comment<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">articleid</span><span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">userid</span><span class="token operator">:</span> <span class="token string">'1002'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token string">'相忘于江湖'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdatetime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-05T22:08:15.522Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">likenum</span><span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">articleid</span><span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'我夏天空腹喝凉开水，冬天喝温开水'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">userid</span><span class="token operator">:</span> <span class="token string">'1005'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token string">'伊人憔悴'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdatetime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-05T23:58:51.485Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">likenum</span><span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">articleid</span><span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'我一直喝凉开水，冬天夏天都喝。'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">userid</span><span class="token operator">:</span> <span class="token string">'1004'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token string">'杰克船长'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdatetime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T01:05:06.321Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">likenum</span><span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'4'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">articleid</span><span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'专家说不能空腹吃饭，影响健康。'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">userid</span><span class="token operator">:</span> <span class="token string">'1003'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token string">'凯撒'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdatetime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T08:18:35.288Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">likenum</span><span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'5'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">articleid</span><span class="token operator">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'研究表明，刚烧开的水千万不能喝，因为烫嘴。'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">userid</span><span class="token operator">:</span> <span class="token string">'1003'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token string">'凯撒'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">createdatetime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-08-06T11:01:02.521Z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">likenum</span><span class="token operator">:</span> <span class="token function">NumberInt</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h3> <p>查询当前数据库中的文档</p> <h4 id="查询所有文档"><a href="#查询所有文档" class="header-anchor">#</a> 查询所有文档</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.find(&lt;query&gt;, [projection])</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014200519924.png" alt="image-20211014200519924"></p> <h4 id="条件查询"><a href="#条件查询" class="header-anchor">#</a> 条件查询</h4> <p>查询文档中包含此文档内容的所有文档</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.find({键:&quot;内容&quot;})</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="只返回第一个结果"><a href="#只返回第一个结果" class="header-anchor">#</a> 只返回第一个结果</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.findOne({键:&quot;内容&quot;})</span>
db.comment.findOne<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="投影查询"><a href="#投影查询" class="header-anchor">#</a> 投影查询</h4> <p>查询出来的文档 只显示需要的键值对 相对应sql中的查询结果只显示指定列</p> <p>find传参时给出指定的键字段  1为查询此键  0为过滤此键   默认自动包含查询_id键</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.find({键:&quot;内容&quot;},{键:1,键:0})  </span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>content:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询包含100001文档中的 content键内容</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>articleid:<span class="token string">&quot;100001&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>content:1,_id:0<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#默认查询包含_id 可以通过0过滤</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//语法</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token comment">//或</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
	<span class="token operator">&lt;</span>query<span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token operator">&lt;</span>update<span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		<span class="token literal-property property">upsert</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		<span class="token literal-property property">multi</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		<span class="token literal-property property">writeConcern</span><span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		<span class="token literal-property property">collation</span><span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		<span class="token literal-property property">arrayFilters</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span>filterdocument1<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token literal-property property">hint</span><span class="token operator">:</span> 	<span class="token operator">&lt;</span>document<span class="token operator">|</span>string<span class="token operator">&gt;</span> 				<span class="token comment">// Available starting in MongoDB 4.2</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014202959460.png" alt="image-20211014202959460"></p> <h4 id="覆盖修改"><a href="#覆盖修改" class="header-anchor">#</a> 覆盖修改</h4> <p>修改指定文档 并覆盖更新整个文档 即修改为当前语句中的字段 原先字段不保留</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#可以理解为删除原文档并插入此文档</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="局部修改"><a href="#局部修改" class="header-anchor">#</a> 局部修改</h4> <p>我们可以通过修改器<code>$set</code>来修改指定键的内容  并保留原文档其他内容</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#默认只修改符合条件的第一条数据</span>
db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$set</span>:<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">778</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#修改所有符合条件的数据需要加上参数{multi:true}</span>
db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$set</span>:<span class="token punctuation">{</span>nickname:<span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>multi:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="列值增长修改"><a href="#列值增长修改" class="header-anchor">#</a> 列值增长修改</h4> <p>通过<code>$inc</code>运算符实现 可以对该键的值进行递增 递减</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.update<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$inc</span>:<span class="token punctuation">{</span>likenum:NumberInt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h3> <h4 id="条件删除"><a href="#条件删除" class="header-anchor">#</a> 条件删除</h4> <p>删除符合条件的文档</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.集合.remove({条件})</span>
db.comment.remove<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#返回值为删除多少条数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="删除全部"><a href="#删除全部" class="header-anchor">#</a> 删除全部</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.remove<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="文档的分页查询"><a href="#文档的分页查询" class="header-anchor">#</a> 文档的分页查询</h2> <h3 id="统计查询"><a href="#统计查询" class="header-anchor">#</a> 统计查询</h3> <p>使用count()方法</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.collection.count<span class="token punctuation">(</span>query, options<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014205136962.png" alt="image-20211014205136962"></p> <h4 id="统计当前集合所有文档数"><a href="#统计当前集合所有文档数" class="header-anchor">#</a> 统计当前集合所有文档数</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.count<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#返回值是文档数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="按条件查询"><a href="#按条件查询" class="header-anchor">#</a> 按条件查询</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.count<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="分页列表查询"><a href="#分页列表查询" class="header-anchor">#</a> 分页列表查询</h3> <p>通过limit()方法 读取指定数量的数据 使用skip()方法跳过指定数量的数据</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.find().limit(number).skip(number)</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">#查询前3条的数据</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">#跳过前3条的数据</span>

db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#第一页</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#第二页</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="排序查询"><a href="#排序查询" class="header-anchor">#</a> 排序查询</h3> <p>sort()方法对数据进行排序  使用1和-1来指定升序和降序  sort({键:1})  默认以id进行升序</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.sort<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:-1,likenum:1<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#对userid的内容进行降序 再对likenum的内容进行升序</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="分页和排序查询的顺序"><a href="#分页和排序查询的顺序" class="header-anchor">#</a> 分页和排序查询的顺序</h3> <p>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</p> <h2 id="高级查询"><a href="#高级查询" class="header-anchor">#</a> 高级查询</h2> <h3 id="正则条件查询"><a href="#正则条件查询" class="header-anchor">#</a> 正则条件查询</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.集合.find({键:/正则表达式/})</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>content:/^专家/<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="比较查询"><a href="#比较查询" class="header-anchor">#</a> 比较查询</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$gt</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 大于: field &gt; value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$lt</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 小于: field &lt; value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$gte</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 大于等于: field &gt;= value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$lte</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 小于等于: field &lt;= value</span>
db.集合名称.find<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;field&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$ne</span><span class="token builtin class-name">:</span> value <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 不等于: field != value</span>

<span class="token comment">#例子</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="包含查询"><a href="#包含查询" class="header-anchor">#</a> 包含查询</h3> <p>使用<code>$in</code> 查询包含指定内容的文档</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token punctuation">{</span><span class="token variable">$in</span>:<span class="token punctuation">[</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;1004&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="不包含查询"><a href="#不包含查询" class="header-anchor">#</a> 不包含查询</h3> <p>使用<code>$nin</code> 查询不包含指定内容的文档</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:<span class="token punctuation">{</span><span class="token variable">$nin</span>:<span class="token punctuation">[</span><span class="token string">&quot;1003&quot;</span>,<span class="token string">&quot;1004&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="条件连接查询"><a href="#条件连接查询" class="header-anchor">#</a> 条件连接查询</h3> <p>前面我们通过<code>$set</code>查询单条件的文档  如果为多条件则需要使用 <code>$and</code>进行查询</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$and</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gte</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$lt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 查询likenum 大于等于700 并且小于2000的文档</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="或者连接"><a href="#或者连接" class="header-anchor">#</a> 或者连接</h4> <p>使用<code>$or</code>进行查询</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$or</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$gte</span>:NumberInt<span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>likenum:<span class="token punctuation">{</span><span class="token variable">$lt</span>:NumberInt<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 查询likenum 大于等于700 并且小于2000的文档</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <p>MongoDB没有下索引下 是进行全集合扫描 如果数据量较大时查询效率非常低</p> <p>MongoDB索引使用B树数据结构(B-Tree,MySQL是B+Tree)</p> <h3 id="单字段索引"><a href="#单字段索引" class="header-anchor">#</a> 单字段索引</h3> <p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引 称为单字段索引</p> <p>对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213412158.png" alt="image-20211014213412158"></p> <h3 id="复合索引"><a href="#复合索引" class="header-anchor">#</a> 复合索引</h3> <p>复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由 { userid: 1, score:  -1 } 组成，则索引首先按userid正序排序，然后
在每个userid的值内，再在按score倒序排序。</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213438408.png" alt="image-20211014213438408"></p> <h3 id="其他索引"><a href="#其他索引" class="header-anchor">#</a> 其他索引</h3> <ul><li><p>地理空间索引（Geospatial Index）
为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面
几何的二维球面索引。</p></li> <li><p>文本索引（Text Indexes）
MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），
而将集合中的词作为词干，只存储根词。</p></li> <li><p>哈希索引（Hashed Indexes）
为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支
持相等匹配，不支持基于范围的查询。</p></li></ul> <h3 id="索引管理"><a href="#索引管理" class="header-anchor">#</a> 索引管理</h3> <h4 id="查看索引"><a href="#查看索引" class="header-anchor">#</a> 查看索引</h4> <p>返回一个集合中的所有索引的数组   _id主键自带索引为升序</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.comment.getIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="创建索引"><a href="#创建索引" class="header-anchor">#</a> 创建索引</h4> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014213916168.png" alt="image-20211014213916168"></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.createIndex(keys, options)</span>
db.comment.createIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 给userid创建索引 为升序 索引名默认为键名后加上_(1或者-1)</span>
db.comment.createIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1,nickname:-1<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#复合索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="删除索引"><a href="#删除索引" class="header-anchor">#</a> 删除索引</h4> <p>如果要删除<strong>文本索引</strong>只能通过索引名删除</p> <p>_id索引无法删除</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.dropIndex(索引名)</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#删除所有索引</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token string">&quot;userid_1_nickname_-1&quot;</span><span class="token punctuation">)</span> <span class="token comment">#删除指定索引</span>
db.comment.dropIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>userid:1<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#根据创建索引条件删除索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="索引的使用"><a href="#索引的使用" class="header-anchor">#</a> 索引的使用</h3> <p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。
那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.collection.find(query,options).explain(options)</span>
db.comment.find<span class="token punctuation">(</span><span class="token punctuation">{</span>uderid:<span class="token string">&quot;1003&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>.explain<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>关键点看： <code>&quot;stage&quot;</code> : <code>&quot;COLLSCAN&quot;</code>, 表示全集合扫描</p> <p>​					 <code>&quot;stage&quot;</code> : <code>&quot;IXSCAN&quot;</code> ,基于索引的扫描</p> <h3 id="涵盖查询"><a href="#涵盖查询" class="header-anchor">#</a> 涵盖查询</h3> <p>Covered Queries
当<strong>查询条件</strong>和<strong>查询的投影</strong>仅包含<strong>索引字段</strong>时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效。  其实就是查询符合查询条件 索引字段的值</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211014232035127.png" alt="image-20211014232035127"></p> <h2 id="java连接mongodb"><a href="#java连接mongodb" class="header-anchor">#</a> Java连接MongoDB</h2> <ol><li>mongodb-driver  是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver
的基本使用。
官方驱动说明和下载： http://mongodb.github.io/mongo-java-driver/
官方驱动示例文档：http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</li> <li>SpringDataMongoDB  SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。
官网主页： https://projects.spring.io/spring-data-mongodb/</li></ol> <h2 id="评论案例"><a href="#评论案例" class="header-anchor">#</a> 评论案例</h2> <h3 id="模块搭建"><a href="#模块搭建" class="header-anchor">#</a> 模块搭建</h3> <ol><li>继承spring-boot项目 导入springdataMongoDB坐标</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-mongodb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ol start="2"><li><p>创建application.yml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.130.212  <span class="token comment"># 主机地址</span>
      <span class="token key atrule">database</span><span class="token punctuation">:</span> articledb  <span class="token comment"># 数据库</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span> <span class="token comment"># 默认端口是27017</span>
      <span class="token comment">#也可以使用uri连接</span>
      <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015131818984.png" alt="image-20211015131818984"></p></li></ol> <h3 id="实体类"><a href="#实体类" class="header-anchor">#</a> 实体类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Id</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">CompoundIndex</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">Indexed</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 文章评论实体类
 */</span>
<span class="token comment">//把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span>
<span class="token comment">//@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span>
<span class="token comment">// 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span>
<span class="token comment">// 若添加 @Document ，则 save 到 comment collection</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span><span class="token comment">//可以省略，如果省略，则默认使用类名小写映射集合 会映射到与类名一致的集合当中</span>
<span class="token comment">//复合索引</span>
<span class="token comment">// @CompoundIndex( def = &quot;{'userid': 1, 'nickname': -1}&quot;)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span><span class="token comment">//主键</span>
    <span class="token comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span><span class="token comment">//吐槽内容</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> publishtime<span class="token punctuation">;</span><span class="token comment">//发布日期</span>
    <span class="token comment">//添加了一个单字段的索引</span>
    <span class="token annotation punctuation">@Indexed</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span><span class="token comment">//发布人ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span><span class="token comment">//昵称</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createdatetime<span class="token punctuation">;</span><span class="token comment">//评论的日期时间</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> likenum<span class="token punctuation">;</span><span class="token comment">//点赞数</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> replynum<span class="token punctuation">;</span><span class="token comment">//回复数</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> state<span class="token punctuation">;</span><span class="token comment">//状态</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentid<span class="token punctuation">;</span><span class="token comment">//上级ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> articleid<span class="token punctuation">;</span>

    <span class="token comment">//getter and setter.....</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getPublishtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> publishtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPublishtime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> publishtime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>publishtime <span class="token operator">=</span> publishtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserid</span><span class="token punctuation">(</span><span class="token class-name">String</span> userid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userid <span class="token operator">=</span> userid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token class-name">String</span> nickname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">LocalDateTime</span> <span class="token function">getCreatedatetime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> createdatetime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreatedatetime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span> createdatetime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>createdatetime <span class="token operator">=</span> createdatetime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getLikenum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> likenum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLikenum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> likenum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>likenum <span class="token operator">=</span> likenum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getReplynum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> replynum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReplynum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> replynum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replynum <span class="token operator">=</span> replynum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getParentid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parentid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parentid <span class="token operator">=</span> parentid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getArticleid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> articleid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setArticleid</span><span class="token punctuation">(</span><span class="token class-name">String</span> articleid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>articleid <span class="token operator">=</span> articleid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Comment{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;id='&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, content='&quot;</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, publishtime=&quot;</span> <span class="token operator">+</span> publishtime <span class="token operator">+</span>
                <span class="token string">&quot;, userid='&quot;</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, nickname='&quot;</span> <span class="token operator">+</span> nickname <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, createdatetime=&quot;</span> <span class="token operator">+</span> createdatetime <span class="token operator">+</span>
                <span class="token string">&quot;, likenum=&quot;</span> <span class="token operator">+</span> likenum <span class="token operator">+</span>
                <span class="token string">&quot;, replynum=&quot;</span> <span class="token operator">+</span> replynum <span class="token operator">+</span>
                <span class="token string">&quot;, state='&quot;</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, parentid='&quot;</span> <span class="token operator">+</span> parentid <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, articleid='&quot;</span> <span class="token operator">+</span> articleid <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><ul><li>@Document(collection = &quot;comment&quot;)   声明为mongodb文档 并且映射到comment集合中   如果当前实体类名与集合一致则collection可以忽略(并且只能是小写名称的实体类)</li> <li>@CompoundIndex( def = &quot;{'userid': 1, 'nickname': -1}&quot;)    复合索引 def属性与设置复活索引条件一致 为键和排序方式</li> <li>@Id   声明此属性为主键  如果属性名为id则该注解可以省略不加</li> <li>@Field(&quot;content&quot;)   当成员属性名称与集合中的键字段不一致时 可以使用该注解映射为集合中指定的键字段 此时映射为content键字段</li> <li>@Indexed  添加为单字段索引</li></ul> <h3 id="增删改查方法"><a href="#增删改查方法" class="header-anchor">#</a> 增删改查方法</h3> <ol><li><p>创建dao层接口 并继承MongoRepository 泛型为 实体类 和 id的类型</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">MongoRepository</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CommentRepository</span> <span class="token keyword">extends</span> <span class="token class-name">MongoRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>创建Service层 注入dao层 并调用动态代理里的方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">CommentRepository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CommentRepository</span> commentRepository<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存一个评论
     *
     * @param comment
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span>
        <span class="token comment">//设置一些默认初始值。。。</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新评论
     *
     * @param comment
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据id删除评论
     *
     * @param id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCommentById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        commentRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询所有评论
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据id查询评论
     *
     * @param id
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Comment</span> <span class="token function">findCommentById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用dao</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div></li></ol> <h3 id="创建测试方法"><a href="#创建测试方法" class="header-anchor">#</a> 创建测试方法</h3> <ol><li><p>新建junit测试方法 类路径要与主程序一致</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">Comment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>itcatst<span class="token punctuation">.</span>article<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CommentService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentServiceTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CommentService</span> commentService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFindCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> commentList <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commentList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFndCommentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Comment</span> commentById <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentById</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commentById<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 保存一个评论
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSaveComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Comment</span> comment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处没有指定id 但MongoDB默认自动生成 我们推荐自动生成 不推荐自己书写id</span>
        comment<span class="token punctuation">.</span><span class="token function">setArticleid</span><span class="token punctuation">(</span><span class="token string">&quot;100000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">&quot;测试添加的数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setCreatedatetime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setUserid</span><span class="token punctuation">(</span><span class="token string">&quot;1003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;凯撒大帝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setLikenum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setReplynum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        commentService<span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div></li></ol> <h3 id="分页查询测试"><a href="#分页查询测试" class="header-anchor">#</a> 分页查询测试</h3> <ol><li><p>在dao层接口创建新的方法  必须要指定<strong>对应的属性名为方法名</strong>否则会报错</p> <p>格式: Page&lt;实体类&gt; findBy根据哪个属性来查询(传递属性类型 属性名,Pageable pageable);</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">////根据父id，查询子评论的分页列表</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>在service层调用dao层的方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 分页查询
     *
     * @param parentid 根据哪个属性来查询
     * @param page     页码
     * @param size     每页个数
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCommentListByParentid</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentid<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> commentRepository<span class="token punctuation">.</span><span class="token function">findByParentid</span><span class="token punctuation">(</span>parentid<span class="token punctuation">,</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>测试用例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFindCommentListByParentid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentListByParentid</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getTotalElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回总条数</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回结果的集合</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol> <h3 id="评论点赞"><a href="#评论点赞" class="header-anchor">#</a> 评论点赞</h3> <p>最简单的方法就是根据id查询当前对应的文档 并将点赞数+1  但执行效率不高 因为只需要修改点赞数 没有必要把所有的字段都查询出来</p> <p>我们可以使用 MongoTemplate 类实现对某列进行操作</p> <ol><li><p>在service层注入 MongoTemplate  并编修改方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>   <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 点赞数+1
     *
     * @param id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCommentLikenum</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询条件</span>
        <span class="token comment">//Query query = Query.query(Criteria.where(&quot;_id&quot;).is(id)).addCriteria(Criteria.where(&quot;nickname&quot;).is(&quot;凯撒大帝&quot;));  //使用Criteria.when(键字段).is(条件)  判断条件 addCriteria可以无限扩展条件</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新条件</span>
        <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;likenum&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将likenum数+1  如单传键字段则自动加1</span>
<span class="token comment">//        update.set()</span>

        mongoTemplate<span class="token punctuation">.</span><span class="token function">updateFirst</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ol> <h2 id="副本集"><a href="#副本集" class="header-anchor">#</a> 副本集</h2> <p>MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高
可用性，是所有生产部署的基础。</p> <p>主从复制和副本集区别
主从集群和副本集最大的区别就是副本集没有固定的“主节点”；整个集群会选出一个“主节点”，当其挂
掉后，又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多
个备份节点(从、secondary)。</p> <p>副本集有两种类型三种角色:</p> <p>两种类型：</p> <ul><li>主节点（ Primary）类型：数据操作的主要连接点，可读写。</li> <li>次要（辅助、从）节点（ Secondaries）类型：数据冗余备份节点，可以读或选举。</li></ul> <p>三种角色：</p> <ul><li>主要成员（Primary）：主要接收所有写操作。就是主节点。</li> <li>副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可
以读操作（但需要配置）。是默认的一种从节点类型。</li> <li>仲裁者（ Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副
本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。</li></ul> <h3 id="副本集创建"><a href="#副本集创建" class="header-anchor">#</a> 副本集创建</h3> <h4 id="主节点"><a href="#主节点" class="header-anchor">#</a> 主节点</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#主节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27017/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span> <span class="token comment">#日志文件</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27017/data/db <span class="token comment">#数据文件</span>

<span class="token function">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27017/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称  同一个副本集中集群必须一致</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>启动主节点</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="从节点"><a href="#从节点" class="header-anchor">#</a> 从节点</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#副本节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27018/data/db
<span class="token function">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27018/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27018</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>启动节点</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="仲裁节点"><a href="#仲裁节点" class="header-anchor">#</a> 仲裁节点</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#仲裁节点</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/replica_sets/myrs_27019/data/db
<span class="token function">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 destination<span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 path<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 logAppend<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 dbPath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/data/db&quot;</span>
 journal<span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  enabled<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 fork<span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 pidFilePath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/replica_sets/myrs_27019/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 bindIp<span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 port<span class="token punctuation">:</span> <span class="token number">27019</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 replSetName<span class="token punctuation">:</span> myrs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>启动节点</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="初始化配置副本集和主节点"><a href="#初始化配置副本集和主节点" class="header-anchor">#</a> 初始化配置副本集和主节点</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#使用mongo客户端任意节点都可以 但尽量连上主节点</span>
/usr/local/mongodb/bin/mongo --host<span class="token operator">=</span><span class="token number">192.168</span>.130.212 --port<span class="token operator">=</span><span class="token number">27017</span>

<span class="token comment">#初始化命令</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#使用默认的配置来初始化副本集  “ok”的值为1，说明创建成功  并且此节点变为主节点</span>

rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看默认节点配置</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 查询副本集状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="添加副本从节点"><a href="#添加副本从节点" class="header-anchor">#</a> 添加副本从节点</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#rs.add(host:post)</span>
rs.add<span class="token punctuation">(</span><span class="token number">192.168</span>.130.212:27018<span class="token punctuation">)</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看副本集状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="添加仲裁节点"><a href="#添加仲裁节点" class="header-anchor">#</a> 添加仲裁节点</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#rs.addArb(host:post)</span>
rs.addarB<span class="token punctuation">(</span><span class="token number">192.168</span>.130.212:27019<span class="token punctuation">)</span>

rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看副本集状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="副本集的数据读写操作"><a href="#副本集的数据读写操作" class="header-anchor">#</a> 副本集的数据读写操作</h3> <ol><li><p>只有主节点写入数据和读取数据</p></li> <li><p>默认情况从节点无法读取数据 也无法写入数据  可以进行设置增加读的权限</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#连接从节点的客户端</span>
rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#该命令是 db.getMongo().setSlaveOk() 的简化命令</span>
<span class="token comment">#或者</span>
rs.slaveOk<span class="token punctuation">(</span>true<span class="token punctuation">)</span> 
<span class="token comment">#此时实现了读写分离 让主插入数据 让从来读取数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>仲裁者节点，不存放任何业务数据的，可以登录查看 只存放副本集配置等数据。</p></li></ol> <h3 id="主节点的选举原则"><a href="#主节点的选举原则" class="header-anchor">#</a> 主节点的选举原则</h3> <p>MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p> <ol><li>主节点故障</li> <li>主节点网络不可达（默认心跳信息为10秒）</li> <li>人工干预（rs.stepDown(600)）</li></ol> <p>选举规则是根据票数来决定谁获胜：</p> <ul><li>票数最高，且获得了 “大多数”成员的投票支持的节点获胜。
“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：3个投票成员，
则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，
复制集将无法提供写服务，处于只读状态。</li> <li>若票数相同，且都获得了 “大多数”成员的投票支持的，数据新的节点获胜。
数据的新旧是通过操作日志oplog来对比的。</li></ul> <p>在获得票数的时候，优先级（priority）参数影响重大。
可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加
0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员
更有资格成为主要成员，更低的值可使成员更不符合条件。
默认情况下，优先级的值是1</p> <h3 id="提升优先级"><a href="#提升优先级" class="header-anchor">#</a> 提升优先级</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#先导出配置到变量中</span>
<span class="token assign-left variable">cfg</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#修改指定优先级  ID号默认从0开始</span>
cfg.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.priority<span class="token operator">=</span><span class="token number">2</span>
<span class="token comment">#重新加载配置</span>
rs.reconfig<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="compass连接副本集"><a href="#compass连接副本集" class="header-anchor">#</a> Compass连接副本集</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#将host修改为当前主节点的ip</span>
var config <span class="token operator">=</span> rs.config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 config.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.host<span class="token operator">=</span><span class="token string">&quot;192.168.130.212:27017&quot;</span><span class="token punctuation">;</span>rs.reconfig<span class="token punctuation">(</span>config<span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015155651742.png" alt="image-20211015155651742"></p> <p>选择Primary 为主节点   Secondary为副本集</p> <h3 id="springdatamongodb连接副本集"><a href="#springdatamongodb连接副本集" class="header-anchor">#</a> SpringDataMongoDB连接副本集</h3> <p>mongodb://host1,host2,host3/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=副本集名字</p> <ul><li>slaveOk=true ：开启副本节点读的功能，可实现读写分离。</li> <li>connect=replicaSet ：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分
离</li></ul> <p>主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>spring:
  data:
    mongodb:
      <span class="token comment"># host: 192.168.130.212  # 主机地址</span>
      <span class="token comment"># database: articledb  # 数据库</span>
      <span class="token comment"># port: 27017 # 默认端口是27017</span>
      <span class="token comment">#也可以使用uri连接</span>
      <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
        <span class="token comment"># 副本集的连接字符串</span>
      uri: mongodb://192.168.42.212:27017,192.168.42.212:27018,192.168.42.212:27019/article
      db?connect<span class="token operator">=</span>replicaSet<span class="token operator">&amp;</span><span class="token assign-left variable">slaveOk</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">replicaSet</span><span class="token operator">=</span>myrs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="分片集群"><a href="#分片集群" class="header-anchor">#</a> 分片集群</h2> <p>分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集
和高吞吐量操作的部署。</p> <p>MongoDB分片群集包含以下组件：</p> <ul><li>分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。</li> <li>mongos （路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。</li> <li>config servers （“调度”的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开
始，必须将配置服务器部署为副本集（CSRS）。</li></ul> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015160418466.png" alt="image-20211015160418466"></p> <h3 id="搭建分片集群架构"><a href="#搭建分片集群架构" class="header-anchor">#</a> 搭建分片集群架构</h3> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015160552667.png" alt="image-20211015160552667"></p> <h4 id="第一个副本集"><a href="#第一个副本集" class="header-anchor">#</a> 第一个副本集</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#-----------myshardrs01</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27018/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27118/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27118/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27218/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs01_27218/data/db

<span class="token comment">#myshardrs01_27018</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27018</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token comment">#副本集的名称</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token comment">#分片角色</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>clusterRole 设置分片角色:</p> <ul><li>shardsvr  分片角色</li> <li>configsvr 配置角色</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myshardrs01_27118</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27118</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myshardrs01_27218</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.42.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27218</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs01
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>启动第一套副本集：一主一副本一仲裁</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27018</span> <span class="token comment">#尽量连接主节点</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27118&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27218&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加仲裁节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="第二套副本集"><a href="#第二套副本集" class="header-anchor">#</a> 第二套副本集</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#-----------myshardrs02</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27318/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27318/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27418/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27418/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27518/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myshardrs02_27518/data/db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27318</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27318</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27418</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27418</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myshardrs02_27518</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 destination<span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 path<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 logAppend<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 dbPath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/data/db&quot;</span>
 journal<span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  enabled<span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 fork<span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 pidFilePath<span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 bindIp<span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 port<span class="token punctuation">:</span> <span class="token number">27518</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 replSetName<span class="token punctuation">:</span> myshardrs02
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 clusterRole<span class="token punctuation">:</span> shardsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>启动第二套副本集：一主一副本一仲裁</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf
<span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> mongod <span class="token comment">#一共6个服务</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27318</span> <span class="token comment">#尽量连接主节点</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27418&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27518&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加仲裁节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="配置节点副本集"><a href="#配置节点副本集" class="header-anchor">#</a> 配置节点副本集</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#-----------configrs</span>
<span class="token comment">#建立数据节点data和日志目录</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27019/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27119/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27119/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span>

<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27219/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/myconfigrs_27219/data/db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27019</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27019</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>此时分片角色为配置角色</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27119</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27119</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#myconfigrs_27219</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span>
 <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/data/db&quot;</span>
 <span class="token key atrule">journal</span><span class="token punctuation">:</span>
   <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.pid&quot;</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.42.130.212
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27219</span>
<span class="token key atrule">replication</span><span class="token punctuation">:</span>
 <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myconfigrs
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> configsvr
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>启动配置副本集：一主两副本</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf
<span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> mongod <span class="token comment">#一共9个服务</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>初始化副本集和创建主节点</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27019</span> <span class="token comment">#尽量连接主节点</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#初始化主节点</span>
rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#状态查看</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27119&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#添加副节点</span>
rs.add<span class="token punctuation">(</span><span class="token string">&quot;192.168.130.212:27119&quot;</span><span class="token punctuation">)</span> <span class="token comment">#添加副节点</span>
rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="路由节点创建和连接"><a href="#路由节点创建和连接" class="header-anchor">#</a> 路由节点创建和连接</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#-----------mongos01</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/mymongos_27017/log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#mymongos_27017节点</span>
<span class="token function">vi</span> /mongodb/sharded_cluster/mymongos_27017/mongos.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/mymongos_27017/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> /mongodb/sharded_cluster/mymongos_27017/log/mongod.pid&quot;
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.130.212
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
 <span class="token comment">#指定配置节点副本集</span>
 <span class="token key atrule">configDB</span><span class="token punctuation">:</span> myconfigrs/192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27019</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27119</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27219</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>configDB 地址为 配置副本集名称/配置节点1,配置节点2,配置节点3</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#启动</span>
/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27017/mongos.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#连接 此时为mongos</span>
/usr/local/mongodb/bin/mongo --host <span class="token number">192.168</span>.130.212 --port <span class="token number">27017</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此写不进去数据，如果写数据会报错。</p> <h4 id="路由节点添加分片"><a href="#路由节点添加分片" class="header-anchor">#</a> 路由节点添加分片</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#sh.addShard(副本集名称/主节点,副本节点,仲裁节点)  三种角色节点必须都添加到路由中 </span>
sh.addShard<span class="token punctuation">(</span><span class="token string">&quot;myshardrs01/192.168.42.130.212:27018,192.168.42.130.212:27118,192.168.42.130.212:27218&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#第一套</span>
sh.addShard<span class="token punctuation">(</span><span class="token string">&quot;myshardrs02/192.168.42.130.212:27318,192.168.42.130.212:27418,192.168.42.130.212:27518&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#第二套</span>
sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查询分片状态</span>
<span class="token comment">#sh.enableSharding(&quot;库名&quot;)</span>
sh.enableSharding<span class="token punctuation">(</span><span class="token string">&quot;articledb&quot;</span><span class="token punctuation">)</span> <span class="token comment">#开启分片功能</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="集合分片和分片规则"><a href="#集合分片和分片规则" class="header-anchor">#</a> 集合分片和分片规则</h5> <p>sh.shardCollection(namespace, key, unique)</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015165012819.png" alt="image-20211015165012819"></p> <ol><li><p>分片规则一：哈希策略
对指定字段的值 进行哈希计算出存放的位置  每个副本集对应则对应的范围 通过哈希计算出存放的副本集中</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>sh.shardCollection<span class="token punctuation">(</span><span class="token string">&quot;articledb.comment&quot;</span>,<span class="token punctuation">{</span><span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;hashed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>分片规则二：范围策略
对于 基于范围的分片 ,MongoDB按键的范围把数据分成不同部分.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>sh.shardCollection<span class="token punctuation">(</span><span class="token string">&quot;articledb.author&quot;</span>,<span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>注意事项:</p> <ul><li>一个集合只能指定一个片键，否则报错。</li> <li>一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新
分片键的值。</li> <li>根据age索引进行分配数据</li></ul> <p>如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use admin
db.runCommand<span class="token punctuation">(</span> <span class="token punctuation">{</span> removeShard: <span class="token string">&quot;myshardrs02&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.printShardingStatus<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#显示集群的详细信息</span>
sh.isBalancerRunning<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#查询交换器是否工作</span>
sh.getBalancerState<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看Balancer状态 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="范围规则配置数据块大小"><a href="#范围规则配置数据块大小" class="header-anchor">#</a> 范围规则配置数据块大小</h5> <p>范围规则默认存放在数据块中 如果数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use config
db.settings.save<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">&quot;chunksize&quot;</span>, value: <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#默认为64m</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="追加路由节点"><a href="#追加路由节点" class="header-anchor">#</a> 追加路由节点</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#-----------mongos02</span>
<span class="token function">mkdir</span> -p /mongodb/sharded_cluster/mymongos_27117/log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vi</span> /mongodb/sharded_cluster/mymongos_27117/mongos.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
 <span class="token comment">#MongoDB发送所有日志输出的目标指定为文件</span>
 <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
 <span class="token comment">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span>
 <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/mongodb/sharded_cluster/mymongos_27117/log/mongod.log&quot;</span>
 <span class="token comment">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span>
 <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
 <span class="token comment">#启用在后台运行mongos或mongod进程的守护进程模式。</span>
 <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token comment">#指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span>
 <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> /mongodb/sharded_cluster/mymongos_27117/log/mongod.pid&quot;
<span class="token key atrule">net</span><span class="token punctuation">:</span>
 <span class="token comment">#服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span>
 <span class="token comment">#bindIpAll: true</span>
 <span class="token comment">#服务实例绑定的IP</span>
 <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.0.2
 <span class="token comment">#bindIp</span>
 <span class="token comment">#绑定的端口</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27117</span>
<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
<span class="token key atrule">configDB</span><span class="token punctuation">:</span>
myconfigrs/192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27019</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27119</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27219</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#启动</span>
/usr/local/mongodb/bin/mongos -f /mongodb/sharded_cluster/mymongos_27117/mongos.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第二个路由无需配置，因为分片配置都保存到了配置服务器中了。</p> <h3 id="compass连接分片集群"><a href="#compass连接分片集群" class="header-anchor">#</a> Compass连接分片集群</h3> <p>连接路由节点即可</p> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015183225341.png" alt="image-20211015183225341"></p> <h3 id="springdatamongdb-连接分片集群"><a href="#springdatamongdb-连接分片集群" class="header-anchor">#</a> SpringDataMongDB 连接分片集群</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
      <span class="token comment"># host: 192.168.130.212  # 主机地址</span>
      <span class="token comment"># database: articledb  # 数据库</span>
      <span class="token comment"># port: 27017 # 默认端口是27017</span>
        <span class="token comment">#也可以使用uri连接</span>
        <span class="token comment">#uri: mongodb://192.168.40.134:27017/articledb</span>
      <span class="token comment"># 副本集的连接字符串</span>
            <span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//192.168.40.134<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.40.134<span class="token punctuation">:</span>27117/articledb

<span class="token comment">#      uri: mongodb://192.168.42.212:27017,192.168.42.212:27018,192.168.42.212:27019/article</span>
<span class="token comment">#      db?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果有多个节点可以使用逗号隔开 SpringDataMongDB默认有负载均衡策略</p> <h2 id="安全认证"><a href="#安全认证" class="header-anchor">#</a> 安全认证</h2> <p>默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的</p> <h3 id="角色"><a href="#角色" class="header-anchor">#</a> 角色</h3> <p>常用的内置角色：</p> <ul><li>数据库用户角色： read、readWrite;</li> <li>所有数据库用户角色： readAnyDatabase、readWriteAnyDatabase、</li> <li>userAdminAnyDatabase、dbAdminAnyDatabase</li> <li>数据库管理角色： dbAdmin、dbOwner、userAdmin；</li> <li>集群管理角色： clusterAdmin、clusterManager、clusterMonitor、hostManager；</li> <li>备份恢复角色： backup、restore；</li> <li>超级用户角色： root</li> <li>内部角色： system</li></ul> <p><img src="https://gitee.com/Iekrwh/md-images/raw/master/images/image-20211015183741098.png" alt="image-20211015183741098"></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询所有角色权限(仅用户自定义角色)</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token number">1</span>, showBuiltinRoles: <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询所有角色权限(包含内置角色)</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token string">&quot;&lt;rolename&gt;&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#查询当前数据库中的某角色的权限</span>
db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> rolesInfo: <span class="token punctuation">{</span> role: <span class="token string">&quot;&lt;rolename&gt;&quot;</span>, db: <span class="token string">&quot;&lt;database&gt;&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>   <span class="token comment">#查询其它数据库中指定的角色权限</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="单实例安全认证"><a href="#单实例安全认证" class="header-anchor">#</a> 单实例安全认证</h3> <ul><li>添加用户和权限</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#创建myroot用户 密码123456 权限为root  如果不指定db名称则默认为当前所在库</span>
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myadmin&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">{</span>role:<span class="token string">&quot;userAdminAnyDatabase&quot;</span>,db:<span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#创建一个在指定库中管理用户的用户</span>
db.system.users.find<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#查询已经创建的用户情况</span>
db.dropUser<span class="token punctuation">(</span><span class="token string">&quot;myadmin&quot;</span><span class="token punctuation">)</span> <span class="token comment">#删除指定用户</span>
db.changeUserPassword<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>, <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>  <span class="token comment">#修改指定用户密码</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li>本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即
可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。</li> <li>和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对
应的表中。Mongodb存储所有的用户信息在admin 数据库的集合system.users中，保存用户名、密码
和数据库信息。</li> <li>如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如 <code>{role:&quot;userAdminAnyDatabase&quot;, db:&quot;&quot;}</code></li></ol> <ul><li>认证测试</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use admin
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用
户，再通过myadmin用户去创建其他角色的用户</p> <h4 id="服务端开启认证和客户端连接登陆"><a href="#服务端开启认证和客户端连接登陆" class="header-anchor">#</a> 服务端开启认证和客户端连接登陆</h4> <ol><li><p>参数方式  启动服务端时加锁--auth参数</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf --auth
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>配置方式</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/single/mongod.conf

<span class="token comment">#配置文件追加</span>
security:
 authorization: enabled  <span class="token comment">#开启授权认证</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#此时连接可以进入客户端 但无法执行任何操作 只有认证成功后能使用</span>
use admin  <span class="token comment">#此用户能查看什么库就切换到什么库中再认证  否则报错</span>
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>连接客户端时直接认证  同样查看什么库就切换到什么库中再认证  否则报错</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongo --host <span class="token number">192.168</span>.42.130.212 --port <span class="token number">27017</span> --authenticationDatabase admin -u myroot -p <span class="token number">123456</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>-u ：用户名</li> <li>-p ：密码</li> <li>-- authenticationDatabase ：指定连接到哪个库。当登录是指定用户名密码时，必须指定对应的
数据库！</li></ul> <h4 id="springdatamongodb连接认证"><a href="#springdatamongodb连接认证" class="header-anchor">#</a> SpringDataMongoDB连接认证</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment"># 主机地址</span>
<span class="token comment">#   host: 192.168.42.130.212</span>
   <span class="token comment"># 数据库</span>
<span class="token comment">#   database: articledb</span>
   <span class="token comment"># 默认端口是27017</span>
<span class="token comment">#   port: 27017</span>
   <span class="token comment">#帐号</span>
<span class="token comment">#   username: bobo</span>
   <span class="token comment">#密码</span>
<span class="token comment">#   password: 123456</span>
   <span class="token comment">#单机有认证的情况下，也使用字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.130.212/articledb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="副本集环境"><a href="#副本集环境" class="header-anchor">#</a> 副本集环境</h3> <p>只需要在主节点上添加用户，副本集会自动同步</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>生成副本集认证的key文件 在centos中</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>openssl rand -base64 <span class="token number">90</span> -out ./mongo.keyfile
<span class="token function">chmod</span> <span class="token number">400</span> ./mongo.keyfile
ll mongo.keyfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须
有读的权限，否则将来会报错</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#此时应该通过网络传输此key文件给集群机器</span>
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27017
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27018
<span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27019
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改各个节点的配置文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27017/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27018/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>重新启动</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf
/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建新的用户读和写</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mongo
use admin
db.auth<span class="token punctuation">(</span><span class="token string">&quot;myroot&quot;</span>,<span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span> <span class="token comment">#先登陆认证管理员账号</span>
use articledb
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user: <span class="token string">&quot;bobo&quot;</span>, pwd: <span class="token string">&quot;123456&quot;</span>, roles: <span class="token punctuation">[</span><span class="token string">&quot;readWrite&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="springdatamongodb连接副本集-2"><a href="#springdatamongodb连接副本集-2" class="header-anchor">#</a> SpringDataMongoDB连接副本集</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment">#副本集有认证的情况下，字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span>
mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27018</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span>27019/articledb<span class="token punctuation">?</span>connect=replicaSet<span class="token important">&amp;slaveOk=true&amp;replicaSet=myrs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="分片集群环境"><a href="#分片集群环境" class="header-anchor">#</a> 分片集群环境</h3> <p>关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点再关闭路由服务器的服务</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>rs.stepDown<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#告知副本集说本机要下线</span>
use admin 
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>生成key文件</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>openssl rand -base64 <span class="token number">90</span> -out ./mongo.keyfile
<span class="token function">chmod</span> <span class="token number">400</span> ./mongo.keyfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li><p>拷贝key文件到各个服务上</p></li> <li><p>修改配置文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#这里是各个服务上的配置文件</span>
<span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
 <span class="token comment">#KeyFile鉴权文件 注意要修改路径</span>
 <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile
 <span class="token comment">#开启认证方式运行</span>
 <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>重新启动各个节点</p> <p>先启动配置节点，再启动分片节点，最后启动路由节点。如果先启动分片节点，会卡住</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongod -f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>客户端mongo，通过localhost登录任意一个mongos路由</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/usr/local/mongodb/bin/mongo --port <span class="token number">27017</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>创建账号</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>use admin
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;myroot&quot;</span>,pwd:<span class="token string">&quot;123456&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#管理员账号</span>
db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user: <span class="token string">&quot;bobo&quot;</span>, pwd: <span class="token string">&quot;123456&quot;</span>, roles: <span class="token punctuation">[</span><span class="token punctuation">{</span> role: <span class="token string">&quot;readWrite&quot;</span>,db: <span class="token string">&quot;articledb&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">#指定库读写账号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <h4 id="springdatamongodb连接认证-2"><a href="#springdatamongodb连接认证-2" class="header-anchor">#</a> SpringDataMongoDB连接认证</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token comment">#数据源配置</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
 <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
   <span class="token comment"># 分片集群有认证的情况下，字符串连接</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span>
mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.42.130.212<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.42.130.212<span class="token punctuation">:</span>27117/articledb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_4-0新特性"><a href="#_4-0新特性" class="header-anchor">#</a> 4.0新特性</h2> <h3 id="加载外部js文件"><a href="#加载外部js文件" class="header-anchor">#</a> 加载外部js文件</h3> <p>加载当前路径下的js文件 启动shell命令时的路径和js所在路径要一致</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>load<span class="token punctuation">(</span><span class="token string">&quot;aaa.js&quot;</span><span class="token punctuation">)</span> <span class="token comment">#返回true则成功</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="事务性"><a href="#事务性" class="header-anchor">#</a> 事务性</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>sh<span class="token punctuation">.</span>demo_01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">MongoClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">ServerAddress</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Filters</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span></span><span class="token class-name">Document</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Filters</span><span class="token punctuation">.</span>eq<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Updates</span><span class="token punctuation">.</span>inc<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo02</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoClient</span> mongoClient<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoDatabase</span> mongoDatabase<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">MongoCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> collection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token comment">/////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
        <span class="token comment">//副本集</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerAddress</span><span class="token punctuation">&gt;</span></span> servers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerAddress</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">27002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接到数据库 itcast表示数据库名</span>
        mongoDatabase <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打印数据库最开始的状态</span>
        <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//转账 带事务的</span>
        <span class="token function">transerTransacFunds</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务的转账</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">transerTransacFunds</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;------------使用事务------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a向b转账100元，有可能会发生异常，回到之前的状态。两个人的操作在同一个事务中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-------------------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取session</span>
        <span class="token class-name">ClientSession</span> session <span class="token operator">=</span> mongoClient<span class="token punctuation">.</span><span class="token function">startSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//开启事务</span>
            session<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//a减100</span>
            <span class="token function">minusTransacFromA</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> a<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//模拟异常</span>
            <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//b加100</span>
            <span class="token function">addTransacToB</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> b<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//提交事务</span>
            session<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;带事务，转账失败，回到开启事务之前的状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//回滚事务</span>
            session<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//关闭session</span>
            session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出账户状态</span>
            <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务b加100</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addTransacToB</span><span class="token punctuation">(</span><span class="token class-name">ClientSession</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b账户增加100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新文档   将文档中likes=100的文档修改为likes=200</span>
        collection<span class="token punctuation">.</span><span class="token function">updateMany</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token class-name">Filters</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//带事务a减100</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minusTransacFromA</span><span class="token punctuation">(</span><span class="token class-name">ClientSession</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a账户减少100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//inc 表示累加函数</span>
        collection<span class="token punctuation">.</span><span class="token function">updateMany</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token class-name">Filters</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printDataState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//persons表示itcast数据库中的集合名</span>
        collection <span class="token operator">=</span> mongoDatabase<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据库中的起始状态：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//检索所有文档</span>
        <span class="token comment">/**
         * 1. 获取迭代器FindIterable&lt;Document&gt;
         * 2. 获取游标MongoCursor&lt;Document&gt;
         * 3. 通过游标遍历检索出的文档集合
         * */</span>
        <span class="token comment">//1. 获取迭代器FindIterable&lt;Document&gt;</span>
        <span class="token class-name">FindIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> findIterable <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 获取游标MongoCursor&lt;Document&gt;</span>
        <span class="token class-name">MongoCursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> mongoCursor <span class="token operator">=</span> findIterable<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 通过游标遍历检索出的文档集合</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>mongoCursor<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mongoCursor<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><h3 id="聚合数据类型转换"><a href="#聚合数据类型转换" class="header-anchor">#</a> 聚合数据类型转换</h3> <p>https://www.runoob.com/mongodb/mongodb-replication.html</p> <p>MongoDB4.0增加了一个新的聚合操作符：<strong>$convert</strong>,用来进行数据类型的转换。这个类型转换操作符简化了数据的抽取、转换和加载的过程。同时将客户端的处理数据的压力转移到了服务器端。从而减轻了客户端处理数据的压力。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#from -- 转账发起人</span>
<span class="token comment">#to -- 转账接收人</span>
<span class="token comment">#time -- 转账时间</span>
<span class="token comment">#money -- 转账金额</span>
use itcast<span class="token punctuation">;</span>
var one <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:100<span class="token punctuation">}</span><span class="token punctuation">;</span>
var two <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:200,<span class="token string">&quot;time&quot;</span>:ISODate<span class="token punctuation">(</span><span class="token string">&quot;2018-05-11T13:58:51.122Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var thr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:300,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2018-07-10 14:38:50&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var four <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:100,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2017-04-16 14:38:50&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
var five <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:500,<span class="token string">&quot;time&quot;</span>:1569569092514<span class="token punctuation">}</span><span class="token punctuation">;</span>
var six <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;to&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b&quot;</span>,<span class="token string">&quot;money&quot;</span>:500,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Last Friday&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
db.transfer.insertMany<span class="token punctuation">(</span><span class="token punctuation">[</span>one,two,thr,four,five,six<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们发现上述结果的时间每条转账记录都不一致。非常杂乱。有的转账记录是标准的例如ISODate,有的时间是字符串，有的是使用整数表示，而还有的根本没有转账记录。还有的时间是无效的。</p> <p>那么这个时候我们就可以使用MongoDB4.0引入的数据类型转换的操作符来将转账时间统一为一致的数据类型。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>conversionStage<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token comment">//聚合通道</span>
    <span class="token literal-property property">$project</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token comment">//在数据映射通道中保留原来的数据项，设置为1</span>
        <span class="token literal-property property">from</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">to</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">money</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">time</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">//转账时间需要做一些类型的转换</span>
            <span class="token comment">//转换操作符</span>
            <span class="token literal-property property">$convert</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token comment">//必须书写的 原来的转账时间</span>
                <span class="token literal-property property">input</span><span class="token operator">:</span><span class="token string">&quot;$time&quot;</span><span class="token punctuation">,</span>
                <span class="token comment">//必须书写的 希望把这一项数据转换哪种类型，date就是mongo的标准时间类型ISODate</span>
                <span class="token literal-property property">to</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
                <span class="token comment">//onError这一项是可选的。对于存在的属性，但是属性值是完全没有办法转换为标准的日期格式，可以对其显示。</span>
                <span class="token literal-property property">onError</span><span class="token operator">:</span><span class="token punctuation">{</span>
                	<span class="token comment">//$concat表示字段拼接操作符</span>
                    <span class="token literal-property property">$concat</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;can not convert &quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">$toString</span><span class="token operator">:</span><span class="token string">&quot;$time&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot; to date type&quot;</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//缺失转账时间这一项，可以对其提示</span>
                <span class="token literal-property property">onNull</span><span class="token operator">:</span><span class="token string">&quot;missing time&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>使用聚合函数aggregate()处理上述数据。执行转换操作</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#db.集合名.aggregate([聚合操作内容])</span>
db.transfer.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>conversionStage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/Iekrwh/blog-VuePress-theme-vdoing/edit/master/docs/后端/04.SQL/24.MongoDB.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/03/18, 07:01:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/4e4f7f/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Redis高级</div></a> <a href="/pages/35c9ab/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">IDE</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/4e4f7f/" class="prev">Redis高级</a></span> <span class="next"><a href="/pages/35c9ab/">IDE</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/88e08c/"><div>
            堆(优先级队列)
            <!----></div></a> <span class="date">03-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fe2eaf/"><div>
            递归
            <!----></div></a> <span class="date">03-18</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/38d7c8/"><div>
            最基本的数据结构
            <!----></div></a> <span class="date">03-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:iekr_wh@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Iekrwh" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="http://music.163.com/album?id=73927024" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div></div></div>
    <script src="/assets/js/app.40dd8ecd.js" defer></script><script src="/assets/js/2.6a9cea3c.js" defer></script><script src="/assets/js/3.6634b688.js" defer></script><script src="/assets/js/184.15b6aa3d.js" defer></script><script src="/assets/js/5.69b21161.js" defer></script>
  </body>
</html>
